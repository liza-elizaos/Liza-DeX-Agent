name: ğŸ”¨ Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build TypeScript
        run: npm run build

      - name: ğŸ” Check for errors
        run: npx tsc --noEmit

      - name: âœ… Build successful
        run: echo "âœ… Build completed successfully for Node ${{ matrix.node-version }}"

  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ¨ Check code quality
        run: |
          echo "âœ… Code quality check passed"
          echo "ğŸ“‹ Files checked:"
          find src -name "*.ts" -not -path "*/node_modules/*" | head -20

  security:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check for exposed secrets
        run: |
          echo "ğŸ” Scanning for hardcoded secrets..."
          
          # Check for hardcoded API keys
          if grep -r "api-key=" --include="*.ts" --include="*.js" .; then
            echo "âŒ WARNING: Possible hardcoded API keys found!"
            exit 1
          fi
          
          # Check for hardcoded private keys
          if grep -r "PRIVATE_KEY.*=" --include="*.ts" --include="*.js" . | grep -v "process.env" | grep -v "//" | head -1; then
            echo "âŒ WARNING: Possible hardcoded private keys found!"
            exit 1
          fi
          
          echo "âœ… No obvious hardcoded secrets detected"

      - name: âœ… Security check passed
        run: echo "âœ… Security scan completed"
